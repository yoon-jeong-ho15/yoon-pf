# Project Summary: yoon-pf

This project is a Next.js application that utilizes Supabase for its backend, including authentication and real-time features.

## Key Technologies:

- **Next.js**: React framework for building web applications.
- **Supabase**: Backend-as-a-Service (BaaS) providing database, authentication, and real-time capabilities.
- **NextAuth.js**: Authentication library for Next.js.
- **Tailwind CSS**: Utility-first CSS framework.
- **Motion**: Animation library.
- **Quill.js**: Rich text editors (likely for content creation).

## Project Structure:

- `src/app`: Contains Next.js pages and API routes.
  - `src/app/more/chat`: Contains components related to the chat functionality, including `chat-list.tsx`, `message-box.tsx`, and `chatroom-provider.tsx`.
- `src/lib`: Contains utility functions, data fetching logic, and Supabase client initialization.
  - `src/lib/supabase.ts`: Initializes the Supabase client.
  - `src/lib/data.ts`: Handles data fetching and manipulation using Supabase.
  - `src/lib/definitions.ts`: Defines data structures (e.g., `Chatroom`, `User`, `ChatMessage`).
- `src/auth.ts`: Configures NextAuth.js for authentication.

## Core Functionality:

- **Authentication**: Users can sign in using credentials.
- **Chat**: Real-time chat functionality using Supabase Realtime.
  - Users can view chat lists, send messages, and manage chatrooms.
- **Data Management**: Interacts with a Supabase PostgreSQL database for various data operations (e.g., fetching boards, users, chat messages).

# Detail

## DataBase

### Table

#### user

```sql
CREATE TABLE public."user" (
id uuid DEFAULT gen_random_uuid() NOT NULL,
created_at timestamptz DEFAULT now() NOT NULL,
username text NOT NULL,
"password" int4 NULL,
"from" int4 NULL,
profile_pic text NULL,
friend_group int4 NULL,
CONSTRAINT member_username_key UNIQUE (username),
CONSTRAINT user_pkey PRIMARY KEY (id)
);
```

#### chatroom

```sql
CREATE TABLE public.chatroom (
id int8 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 9223372036854775807 START 1 CACHE 1 NO CYCLE) NOT NULL,
title text DEFAULT ''::text NULL,
created_at timestamptz DEFAULT now() NULL,
CONSTRAINT chatroom_pkey PRIMARY KEY (id)
);
```

#### chatroom_member

```sql
CREATE TABLE public.chatroom_member (
chatroom_id int8 NULL,
user_id uuid NULL,
CONSTRAINT fk_chatroom_id FOREIGN KEY (chatroom_id) REFERENCES public.chatroom(id) ON DELETE CASCADE,
CONSTRAINT fk_user_id FOREIGN KEY (user_id) REFERENCES public."user"(id) ON DELETE CASCADE
);
```

#### chat_message

```sql
CREATE TABLE public.chat_message (
id int8 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 9223372036854775807 START 1 CACHE 1 NO CYCLE) NOT NULL,
created_at timestamptz DEFAULT now() NOT NULL,
chatroom int8 NULL,
user_id uuid NULL,
message text NULL,
CONSTRAINT chat_message_pkey PRIMARY KEY (id),
CONSTRAINT chat_message_user_id_fkey FOREIGN KEY (user_id) REFERENCES public."user"(id)
);
```

#### chat_read_status

```sql
create table public.chat_read_status (
id bigint generated by default as identity not null,
message_id bigint not null,
user_id uuid not null,
read_at timestamp with time zone null,
constraint chat_read_status_pkey primary key (id),
constraint unique_message_user unique (message_id, user_id),
constraint fk_message_id foreign KEY (message_id) references chat_message (id) on delete CASCADE,
constraint fk_user_id foreign KEY (user_id) references "user" (id) on delete CASCADE
);
```

#### notification

```sql
CREATE TABLE public.notification (
id int8 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 9223372036854775807 START 1 CACHE 1 NO CYCLE) NOT NULL,
user_id uuid NOT NULL,
"type" public."notification_type" NOT NULL,
"data" jsonb NULL,
read_at timestamptz NULL,
created_at timestamptz DEFAULT now() NOT NULL,
CONSTRAINT notification_pkey PRIMARY KEY (id),
CONSTRAINT notification_user_id_fkey FOREIGN KEY (user_id) REFERENCES public."user"(id)
);
```

#### board

```sql
CREATE TABLE public.board (
id uuid DEFAULT gen_random_uuid() NOT NULL,
created_at timestamptz DEFAULT now() NOT NULL,
title varchar NULL,
writer varchar NULL,
"content" jsonb NULL,
updated_at timestamp DEFAULT now() NULL,
status bool DEFAULT true NULL,
CONSTRAINT board_pkey PRIMARY KEY (id),
CONSTRAINT board_writer_fkey FOREIGN KEY (writer) REFERENCES public."user"(username) ON UPDATE CASCADE
);
```

### View

#### v_chatroom

```sql
CREATE OR REPLACE VIEW public.v_chatroom
AS SELECT cm.chatroom_id,
    c.title,
    u.username,
    u.id AS user_id,
    u.profile_pic
   FROM chatroom_member cm
     JOIN chatroom c ON c.id = cm.chatroom_id
     JOIN "user" u ON cm.user_id = u.id
```

#### v_chat_message

```sql
CREATE OR REPLACE VIEW public.v_chat_message
AS SELECT msg.chatroom AS chatroom_id,
msg.id,
u.username,
u.id AS user_id,
msg.message,
u.profile_pic,
msg.created_at,
( SELECT count(\*) AS count
FROM chat_read_status crs
WHERE crs.message_id = msg.id AND crs.read_at IS NULL) AS un_read
FROM chat_message msg
JOIN "user" u ON msg.user_id = u.id;
```

### Functions

#### get_chatroom_data

```sql
CREATE OR REPLACE FUNCTION public.get_chatroom_data(p_username text)
RETURNS TABLE(id integer, title text, username text, uid uuid, profile_pic text)
LANGUAGE sql
SET search_path TO 'public'
AS $function$
SELECT \*
FROM v_chatroom vch
WHERE vch.username != p_username
AND EXISTS (
SELECT vch2.chatroom_id
FROM v_chatroom vch2
WHERE vch2.username = p_username
AND vch.chatroom_id = vch2.chatroom_id
);
$function$
;
```

#### get_dm_chatroom

```sql
CREATE OR REPLACE FUNCTION public.get_dm_chatroom(userid uuid[], member_count integer)
 RETURNS TABLE(chatroom_id bigint)
 LANGUAGE plpgsql
 SET search_path TO ''
AS $function$
BEGIN
    RETURN QUERY
    SELECT cm.chatroom_id
    FROM public.chatroom_member cm
    WHERE cm.user_id = ANY(userid)
    GROUP BY cm.chatroom_id
    HAVING COUNT(*) = member_count
        AND COUNT(DISTINCT cm.user_id) = array_length(userid, 1)
        AND array_length(userid, 1) = member_count;
END;
$function$
;
```

#### get_group_chatroom

```sql
CREATE OR REPLACE FUNCTION public.get_group_chatroom(userid uuid[], member_count integer, p_title text)
 RETURNS TABLE(chatroom_id bigint)
 LANGUAGE plpgsql
 SET search_path TO ''
AS $function$
BEGIN
    RETURN QUERY
    SELECT cm.chatroom_id
    FROM public.chatroom_member cm
	join public.chatroom c on (cm.chatroom_id = c.id)
    WHERE cm.user_id = ANY(userid)
    GROUP BY cm.chatroom_id, c.title
    HAVING COUNT(*) = member_count
        AND COUNT(DISTINCT cm.user_id) = array_length(userid, 1)
        AND array_length(userid, 1) = member_count
		and c.title = p_title;
END;
$function$
;
```

#### handle_new_chat_message

```sql
CREATE OR REPLACE FUNCTION public.handle_new_chat_message()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
  sender_username TEXT;
  message_preview TEXT;
BEGIN
  SELECT username INTO sender_username
  FROM "user"
  WHERE id = NEW.user_id;

  message_preview := CASE
    WHEN LENGTH(NEW.message) > 20
    THEN LEFT(NEW.message, 20) || '...'
    ELSE NEW.message
  END;

  INSERT INTO chat_read_status (message_id, user_id, read_at)
  SELECT
    NEW.id as message_id,
    cm.user_id,
    CASE
      WHEN cm.user_id = NEW.user_id THEN NOW()
      ELSE NULL
    END as read_at
  FROM chatroom_member cm
  WHERE cm.chatroom_id = NEW.chatroom;

  INSERT INTO notification (user_id, type, data)
  SELECT
    cm.user_id,
    'chat_message'::notification_type,
    jsonb_build_object(
      'chatroom_id', NEW.chatroom,
      'message_id', NEW.id,
      'sender_username', sender_username,
      'message_preview', message_preview,
      'created_at', NEW.created_at
    )
  FROM chatroom_member cm
  WHERE cm.chatroom_id = NEW.chatroom
  AND cm.user_id != NEW.user_id;

  RETURN NEW;
END;
$function$
;
```

#### mark_chatroom_as_read

```sql
CREATE OR REPLACE FUNCTION public.mark_chatroom_as_read(p_chatroom_id bigint, p_user_id uuid)
 RETURNS TABLE(messages_read integer, notifications_read integer)
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
  msg_count INTEGER;
  notif_count INTEGER;
BEGIN
  UPDATE chat_read_status
  SET read_at = NOW()
  WHERE user_id = p_user_id
  AND read_at IS NULL
  AND message_id IN (
    SELECT id FROM chat_message
    WHERE chatroom = p_chatroom_id
    AND user_id != p_user_id
  );

  GET DIAGNOSTICS msg_count = ROW_COUNT;

  UPDATE notification
  SET read_at = NOW()
  WHERE user_id = p_user_id
  AND type = 'chat_message'
  AND read_at IS NULL
  AND (data->>'chatroom_id')::BIGINT = p_chatroom_id;

  GET DIAGNOSTICS notif_count = ROW_COUNT;

  RETURN QUERY SELECT msg_count, notif_count;
END;
$function$
;
```
